#!/usr/bin/env bash

set -e

# VÃ©rifie qu'on est dans un repo git
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "âŒ Pas dans un repo git"
    exit 1
fi

echo "ðŸ“‚ Repo: $(pwd)"
echo

# Status
echo "ðŸ“Š Status actuel:"
git status
echo

# Stage
read -p "ðŸ‘‰ Stage tous les fichiers ? (y/n) " stage_all

if [[ "$stage_all" == "y" ]]; then
    git add .
else
    echo "ðŸ‘‰ Fichiers modifiÃ©s:"
    git status --short
    echo
    read -p "Entrez les fichiers Ã  stage (sÃ©parÃ©s par espace): " files
    git add $files
fi

# VÃ©rifie s'il y a quelque chose Ã  commit
if [[ -z $(git diff --cached --name-only) ]]; then
    echo "âœ” Rien Ã  commit"
    exit 0
fi

# Commit message
echo
read -p "ðŸ“ Message de commit (laisser vide = auto): " msg

if [[ -z "$msg" ]]; then
    msg="Update dotfiles: $(date '+%Y-%m-%d %H:%M:%S')"
fi

git commit -m "$msg"

# Push
read -p "ðŸš€ Push vers remote ? (y/n) " push_confirm
if [[ "$push_confirm" == "y" ]]; then
    git push
fi

# STOW
if command -v stow >/dev/null 2>&1; then
    echo
    read -p "ðŸ”— Voulez-vous utiliser stow ? (y/n) " use_stow

    if [[ "$use_stow" == "y" ]]; then
        echo
        echo "ðŸ“¦ Dossiers disponibles:"
        dirs=(*/)
        for i in "${!dirs[@]}"; do
            echo "[$i] ${dirs[$i]}"
        done

        echo
        read -p "Choisissez les numÃ©ros (ex: 0 2 3) ou 'all': " choice

        if [[ "$choice" == "all" ]]; then
            stow */
        else
            selected=()
            for i in $choice; do
                selected+=("${dirs[$i]}")
            done
            stow "${selected[@]}"
        fi

        echo "âœ” Stow terminÃ©"
    fi
fi