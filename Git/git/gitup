#!/usr/bin/env bash

# Colors
R='\033[0;31m'
G='\033[0;32m'
Y='\033[1;33m'
B='\033[0;34m'
M='\033[0;35m'
C='\033[0;36m'
NC='\033[0m'

# Check if there are changes
if [[ -z $(git status -s) ]]; then
    echo -e "${G}✓${NC} No changes to commit"
    exit 0
fi

# Show status
echo -e "${C}╭─ Changes${NC}"
git status -s | sed 's/^/│ /'
echo -e "${C}╰─${NC}\n"

# Show diff
echo -e "${M}╭─ Diff${NC}"
git diff --stat | sed 's/^/│ /'
echo -e "${M}╰─${NC}\n"

# Get modified files
mapfile -t files < <(git status -s | awk '{print $2}')

# Discard option
if [[ ${#files[@]} -gt 0 ]]; then
    echo -e "${Y}Discard any files?${NC} (enter filename or leave empty)"
    for i in "${!files[@]}"; do
        echo -e "  ${B}$((i+1)).${NC} ${files[$i]}"
    done
    echo -n "> "
    read -r discard

    while [[ -n "$discard" ]]; do
        # Try as number first
        if [[ "$discard" =~ ^[0-9]+$ ]] && [[ $discard -ge 1 ]] && [[ $discard -le ${#files[@]} ]]; then
            file="${files[$((discard-1))]}"
        else
            file="$discard"
        fi

        if git checkout -- "$file" 2>/dev/null; then
            echo -e "${R}✗${NC} Discarded: $file"
        else
            echo -e "${R}!${NC} File not found: $file"
        fi

        echo -n "> "
        read -r discard
    done
    echo
fi

# Check again after discards
if [[ -z $(git status -s) ]]; then
    echo -e "${G}✓${NC} All changes discarded"
    exit 0
fi

# Get commit message
echo -e "${C}Commit message${NC} (empty line to finish):"
msg=""
while IFS= read -r line; do
    [[ -z "$line" ]] && break
    msg="${msg}${msg:+$'\n'}$line"
done

# If no message provided, exit
if [[ -z "$msg" ]]; then
    echo -e "${R}✗${NC} No commit message provided, aborting"
    exit 1
fi

# Execute git commands
echo -e "\n${Y}Pushing...${NC}"
if git add -A && git commit -m "$msg" && git push; then
    echo -e "\n${G}✓ Changes pushed successfully${NC}"
else
    echo -e "\n${R}✗ Error occurred${NC}"
    exit 1
fi